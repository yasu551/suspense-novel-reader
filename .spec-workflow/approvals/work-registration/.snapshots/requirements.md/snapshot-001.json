{
  "id": "snapshot_1762480856343_tutweafhb",
  "approvalId": "approval_1762480856337_1v7e2jhg0",
  "approvalTitle": "作品登録機能：要件定義書の承認",
  "version": 1,
  "timestamp": "2025-11-07T02:00:56.343Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 要件定義書：作品登録機能\n\n## はじめに\n\n作品登録機能は、管理者がProject GutenbergなどのパブリックドメインサイトからURLを指定するだけで、英語小説をシステムに取り込める機能です。この機能により、手動でのテキスト入力やコピー＆ペーストが不要となり、大量の古典作品を効率的にデータベースに登録できます。\n\n### 機能の目的\n- 管理者の作業負荷を大幅に削減\n- 作品メタデータの自動抽出による正確性の向上\n- 章・段落の自動構造化による読書体験の向上\n- 登録後の自動翻訳パイプラインとの連携\n\n### ユーザーへの価値\n- 豊富な作品ラインナップを短期間で実現\n- 構造化されたテキストによる快適な読書体験\n- 翻訳機能との統合による日本語学習支援\n\n## プロダクトビジョンとの整合性\n\n本機能はClaude.mdに記載されたプロダクトビジョン「英語原文の小説を日本語でやさしく読めるようにする」の基盤となります。\n\n- **MVPスコープ（優先度0番）**: 管理画面でのURLベース作品登録・削除機能\n- **自動翻訳機能との連携**: 作品登録完了後、自動的に翻訳ジョブを開始\n- **将来の拡張性**: Project Gutenberg以外のパブリックドメインサイトへの対応が可能な設計\n\n## 要件\n\n### 要件1: Project GutenbergからのURL指定による作品登録\n\n**ユーザーストーリー:** 管理者として、Project GutenbergのHTML形式URLを入力することで、作品のメタデータと本文を自動的にシステムに登録したい。これにより、手動でのテキスト入力作業を削減できる。\n\n#### 受け入れ基準\n\n1. WHEN 管理者が有効なProject Gutenberg URLを入力 THEN システムは30秒以内にメタデータと章・段落を抽出する\n2. WHEN URLからHTMLをフェッチ THEN システムは以下のメタデータを抽出する:\n   - タイトル（`<h1>` または `<title>` タグから）\n   - 著者名（`<h2>` または `rel=\"dcterms:creator\"` 属性から）\n   - 言語（`<html lang=\"...\">` またはメタタグから）\n   - 出典ID（URLから抽出）\n3. WHEN 章の検出 THEN システムは `<h2>`, `<h3>` タグで\"CHAPTER\"を含むものを章として識別する\n4. WHEN 段落の検出 THEN システムは `<p>` タグを段落として識別し、空の段落・ナビゲーション要素を除外する\n5. WHEN 章・段落にID付与 THEN システムは `work-{workId}/chapter-{index}/paragraph-{index}` の形式でユニークIDを生成する\n6. WHEN メタデータと構造化テキストの抽出完了 THEN システムはデータベースに以下のレコードを作成する:\n   - Workレコード（`translation_status: 'pending'`）\n   - Chapterレコード（一括作成）\n   - Paragraphレコード（バッチ処理で一括作成）\n   - TranslationJobレコード\n\n### 要件2: 作品登録後の自動翻訳ジョブ開始\n\n**ユーザーストーリー:** 管理者として、作品登録が完了したら、自動的に翻訳処理が開始されてほしい。これにより、手動で翻訳ジョブを起動する手間が省ける。\n\n#### 受け入れ基準\n\n1. WHEN 作品のデータベース登録が完了 THEN システムは自動的に翻訳ジョブをキューに追加する\n2. WHEN 翻訳ジョブが開始 THEN システムはWorkレコードの `translation_status` を `in_progress` に更新する\n3. WHEN 環境変数 `TRANSLATION_AUTO_START` が `false` AND 作品登録完了 THEN システムは翻訳ジョブを開始せず、`translation_status` を `pending` のままにする\n\n### 要件3: URL検証とエラーハンドリング\n\n**ユーザーストーリー:** 管理者として、無効なURLや取得できないURLを入力した場合、明確なエラーメッセージを受け取りたい。これにより、問題を迅速に特定し修正できる。\n\n#### 受け入れ基準\n\n1. WHEN 管理者がProject Gutenberg以外のURLを入力 THEN システムは400エラーを返し「許可されたドメインではありません」と表示する\n2. WHEN URLからのHTMLフェッチが失敗 THEN システムは502エラーを返し「ページの取得に失敗しました」と表示する\n3. WHEN HTMLのパースが失敗（タイトルまたは著者が抽出できない） THEN システムは422エラーを返し詳細なエラーメッセージを表示する\n4. IF プライベートIPアドレスへのアクセス THEN システムはSSRF対策としてリクエストを拒否する\n5. WHEN 同一URLで既に登録済みの作品が存在 THEN システムは409エラーを返し「この作品は既に登録されています」と表示する\n\n### 要件4: 作品の削除と関連データの連鎖削除\n\n**ユーザーストーリー:** 管理者として、不要な作品を削除する際に、関連する章・段落・進捗データも自動的に削除されてほしい。これにより、データベースの整合性が保たれる。\n\n#### 受け入れ基準\n\n1. WHEN 管理者が作品削除を実行 THEN システムは確認ダイアログを表示する\n2. WHEN 削除が確認される THEN システムは以下の順序でデータを削除する:\n   - TranslationJob（該当作品の翻訳ジョブ）\n   - ChatLog（該当作品の段落を参照するもの）\n   - ReadingProgress（該当作品の段落）\n   - Paragraph（該当作品の章）\n   - Chapter（該当作品）\n   - Work\n3. WHEN 削除処理中にエラーが発生 THEN システムはトランザクションをロールバックし、データの一部削除を防ぐ\n4. IF 進行中の翻訳ジョブが存在 THEN システムは翻訳ジョブをキャンセルしてから削除を実行する\n\n### 要件5: 作品登録のプレビュー機能\n\n**ユーザーストーリー:** 管理者として、作品を正式に登録する前に、抽出されたメタデータと章構造をプレビューしたい。これにより、パース結果が正しいか確認してから登録できる。\n\n#### 受け入れ基準\n\n1. WHEN 管理者がURLを入力して「プレビュー」ボタンをクリック THEN システムはスクレイピング・パースを実行し結果を表示する（DBには保存しない）\n2. WHEN プレビュー画面 THEN システムは以下の情報を表示する:\n   - 抽出されたタイトル\n   - 抽出された著者名\n   - 検出された章数\n   - 検出された段落数\n   - 最初の3章のタイトルと段落プレビュー\n3. WHEN プレビュー結果が正しい AND 管理者が「登録」ボタンをクリック THEN システムはデータベースに保存する\n4. WHEN プレビュー結果が不正 THEN 管理者はURLを修正するか、手動でメタデータを編集してから登録できる\n\n### 要件6: ジャンル・難易度の設定\n\n**ユーザーストーリー:** 管理者として、作品登録時にジャンルと難易度を設定したい。これにより、ユーザーが作品一覧画面でフィルタリングできるようになる。\n\n#### 受け入れ基準\n\n1. WHEN 管理者が作品登録フォームを入力 THEN システムはジャンルの複数選択オプションを提供する:\n   - ゴシック、SF、冒険、恋愛、ミステリー、ホラー、その他\n2. WHEN 管理者が作品登録フォームを入力 THEN システムは難易度の選択オプションを提供する:\n   - やさしい、ふつう、むずかしい\n3. IF 管理者がジャンル・難易度を指定しない THEN システムはデフォルト値（ジャンル: 未分類、難易度: ふつう）を設定する\n4. WHEN 将来的にAIによる自動推定機能を追加 THEN システムは推定値を提案し、管理者が修正可能にする\n\n## 非機能要件\n\n### コードアーキテクチャとモジュール性\n\n- **単一責任の原則**: 各ファイルは明確に定義された単一の目的を持つ\n  - `lib/scraper/gutenberg.ts`: Project Gutenbergのスクレイピング専用\n  - `lib/scraper/parser.ts`: HTML/テキストのパース専用\n  - `app/api/works/route.ts`: 作品一覧・登録APIエンドポイント\n  - `app/api/works/[id]/route.ts`: 作品削除APIエンドポイント\n- **モジュラー設計**: コンポーネント、ユーティリティ、サービスは独立して再利用可能\n  - スクレイパーは他のパブリックドメインサイトに拡張可能\n  - パーサーはテキスト形式にも対応可能\n- **依存関係の管理**: モジュール間の相互依存を最小化\n  - スクレイパーはパーサーに依存しない\n  - APIルートはスクレイパー・パーサーをインポートするが、逆方向の依存は持たない\n- **明確なインターフェース**: コンポーネント間とレイヤー間のクリーンな契約を定義\n  - スクレイパー関数は標準的な戻り値型（`ScrapedWork`）を返す\n  - APIエンドポイントは標準的なHTTPステータスコードとレスポンス形式を使用\n\n### パフォーマンス\n\n- URLから作品を登録すると、30秒以内にメタデータと章・段落が抽出される\n- データベース書き込みはバッチ処理で実行し、1000段落の作品で10秒以内に完了\n- 作品削除は関連データの量に応じて5〜30秒以内に完了\n- プレビュー機能は15秒以内に結果を表示（DBには保存しない）\n\n### セキュリティ\n\n- **URL検証**: 許可されたドメイン（gutenberg.org）のみを受け入れる\n- **SSRF対策**: プライベートIPアドレス（127.0.0.1、192.168.x.x、10.x.x.x等）へのアクセスを禁止\n- **レート制限**: 作品登録は1ユーザー/10分あたり5件まで（IP + ユーザーIDベース）\n- **管理画面へのアクセス制御**: 将来的に認証必須（OAuth or Token）\n- **翻訳ジョブの同時実行制限**: 1作品につき1ジョブまで\n- **入力検証**: URLとメタデータ入力に対するXSS・SQLインジェクション対策\n\n### 信頼性\n\n- データベーストランザクションによる作品削除の原子性保証\n- 翻訳ジョブ開始失敗時のロールバック処理\n- スクレイピング失敗時の詳細なエラーログ記録\n- リトライ機構（一時的なネットワークエラーに対応）\n\n### ユーザビリティ\n\n- 明確で具体的なエラーメッセージ（技術的な詳細ではなく、ユーザーが理解できる言葉）\n- プレビュー機能による登録前の確認\n- 削除確認ダイアログによる誤操作防止\n- 翻訳進捗のリアルタイム表示（5秒以内に更新）\n",
  "fileStats": {
    "size": 10915,
    "lines": 165,
    "lastModified": "2025-11-07T02:00:30.772Z"
  },
  "comments": []
}