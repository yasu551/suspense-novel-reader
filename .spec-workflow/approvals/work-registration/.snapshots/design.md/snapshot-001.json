{
  "id": "snapshot_1762481867527_9ab3fbpcq",
  "approvalId": "approval_1762481867519_tlsy68f67",
  "approvalTitle": "作品登録機能：設計書の承認",
  "version": 1,
  "timestamp": "2025-11-07T02:17:47.526Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 設計書：作品登録機能\n\n## 概要\n\n作品登録機能は、管理者がProject GutenbergなどのパブリックドメインサイトからURLを指定することで、英語小説を自動的にスクレイピング・パースし、データベースに構造化された形式で保存する機能です。この機能はアプリケーション全体の基盤となり、読書機能、翻訳機能、AIチャット機能を支えます。\n\n**主要コンポーネント:**\n- スクレイパー（Project Gutenberg HTML解析）\n- パーサー（章・段落の自動検出とID生成）\n- データベーススキーマ（Work、Chapter、Paragraph、TranslationJob）\n- APIエンドポイント（作品登録・削除）\n- 管理画面UI（作品インポートフォーム、作品リスト）\n\n## ステアリングドキュメントとの整合性\n\n### 技術標準（tech.md）\n\n現在、ステアリングドキュメントは存在しませんが、Claude.mdに記載された技術スタックに従います：\n\n- **Next.js 15 App Router**: サーバーコンポーネントとクライアントコンポーネントの明確な分離\n- **TypeScript**: 型安全性を保証し、APIとデータモデルのインターフェースを明確化\n- **Vercel AI SDK**: 翻訳ジョブとの統合\n- **データベースORM**: Prismaを採用（理由：Next.jsとの相性、型生成、マイグレーション管理）\n- **スクレイピング**: Cheerioを採用（軽量、サーバーサイド専用、DOM操作が不要）\n\n### プロジェクト構造（structure.md）\n\nClaude.mdに記載されたディレクトリ構造に従います：\n\n```\napp/\n  admin/page.tsx                 # 管理画面\n  api/\n    works/route.ts               # POST（作品登録）、GET（作品一覧）\n    works/[id]/route.ts          # DELETE（作品削除）、GET（作品詳細）\nlib/\n  scraper/\n    gutenberg.ts                 # Project Gutenbergスクレイパー\n    parser.ts                    # HTML/テキストパーサー\n  types/\n    work.ts                      # 作品関連の型定義\ncomponents/\n  admin/\n    WorkImportForm.tsx           # 作品登録フォーム\n    WorkList.tsx                 # 作品管理リスト\nprisma/\n  schema.prisma                  # データベーススキーマ\n```\n\n## コード再利用分析\n\n### 既存コンポーネントの活用\n\n現在のプロジェクトは初期段階のため、再利用可能な既存コンポーネントは限定的です：\n\n- **既存のUI コンポーネント**:\n  - `components/ui/*` (Radix/shadcn UI) - ボタン、フォーム、ダイアログなどの基本UIコンポーネント\n  - `lib/utils.ts` の `cn()` 関数 - Tailwind CSSクラスの条件付き結合\n- **Next.js 15 の機能**:\n  - App Router のサーバーコンポーネント\n  - Route Handlers（API Routes）\n  - Server Actions（フォーム送信時に活用可能）\n- **Vercel AI SDK**:\n  - 将来的に翻訳ジョブとの統合に使用\n\n### 新規作成が必要なコンポーネント\n\n- スクレイパー/パーサー（`lib/scraper/*`）\n- データベーススキーマとモデル（`prisma/schema.prisma`）\n- 作品管理API（`app/api/works/*`）\n- 管理画面UI（`app/admin/*`、`components/admin/*`）\n- 型定義（`lib/types/work.ts`）\n\n### 統合ポイント\n\n- **データベース**: Prismaを使用した新規スキーマ作成（既存のデータベースはなし）\n- **Vercel AI SDK**: 将来的に翻訳ジョブAPI（`POST /api/works/:id/translate`）で使用\n- **管理画面**: 既存のUI コンポーネントを活用して構築\n\n## アーキテクチャ\n\n### モジュラー設計の原則\n\n- **単一ファイル責任**: 各ファイルは1つの特定の関心事またはドメインを扱う\n  - `lib/scraper/gutenberg.ts`: Project Gutenberg専用スクレイパー\n  - `lib/scraper/parser.ts`: HTML/テキストのパース専用\n  - `app/api/works/route.ts`: 作品一覧・登録API専用\n  - `app/api/works/[id]/route.ts`: 作品削除API専用\n- **コンポーネントの分離**: 大きなモノリシックファイルではなく、小さく焦点を絞ったコンポーネントを作成\n  - `WorkImportForm.tsx`: 作品登録フォームのみ\n  - `WorkList.tsx`: 作品リスト表示のみ\n- **サービスレイヤーの分離**: データアクセス、ビジネスロジック、プレゼンテーションレイヤーを分離\n  - データアクセス: Prisma Client（`prisma/client`）\n  - ビジネスロジック: スクレイパー/パーサー（`lib/scraper/*`）\n  - プレゼンテーション: React コンポーネント（`components/admin/*`）\n- **ユーティリティのモジュール性**: 焦点を絞った単一目的のモジュールに分割\n  - `lib/scraper/url-validator.ts`: URL検証専用\n  - `lib/scraper/metadata-extractor.ts`: メタデータ抽出専用\n\n### システムアーキテクチャ図\n\n```mermaid\ngraph TD\n    A[管理画面 UI] --> B[WorkImportForm]\n    A --> C[WorkList]\n    B --> D[POST /api/works]\n    C --> E[DELETE /api/works/:id]\n    D --> F[Gutenberg Scraper]\n    D --> G[HTML Parser]\n    F --> H[Cheerio]\n    G --> H\n    D --> I[Prisma Client]\n    E --> I\n    I --> J[(PostgreSQL Database)]\n    D --> K[TranslationJob Queue]\n    K --> L[Vercel AI SDK]\n```\n\n### データフロー\n\n**作品登録フロー:**\n1. 管理者がWorkImportFormにURLを入力\n2. クライアントが `POST /api/works` にリクエスト送信\n3. サーバーがURL検証（`url-validator.ts`）\n4. Gutenberg Scraper（`gutenberg.ts`）がHTMLをフェッチ\n5. HTML Parser（`parser.ts`）が章・段落を検出しID生成\n6. Metadata Extractor（`metadata-extractor.ts`）がメタデータ抽出\n7. Prisma ClientがWork、Chapter、Paragraphレコードを作成\n8. TranslationJobレコードを作成し、翻訳ジョブをキューに追加\n9. クライアントに成功レスポンスを返す\n\n**作品削除フロー:**\n1. 管理者がWorkListで削除ボタンをクリック\n2. 確認ダイアログが表示される\n3. クライアントが `DELETE /api/works/:id` にリクエスト送信\n4. サーバーがトランザクションを開始\n5. 進行中の翻訳ジョブがあればキャンセル\n6. 関連データを連鎖削除（TranslationJob → ChatLog → ReadingProgress → Paragraph → Chapter → Work）\n7. トランザクションをコミット\n8. クライアントに成功レスポンスを返す\n\n## コンポーネントとインターフェース\n\n### 1. Gutenberg Scraper (`lib/scraper/gutenberg.ts`)\n\n- **目的**: Project GutenbergのHTML形式URLからHTMLをフェッチし、基本的なメタデータを抽出\n- **公開インターフェース**:\n  ```typescript\n  export async function scrapeGutenbergWork(url: string): Promise<ScrapedWork>\n  ```\n- **依存関係**:\n  - `cheerio`: HTML解析\n  - `lib/scraper/url-validator.ts`: URL検証\n  - `lib/scraper/metadata-extractor.ts`: メタデータ抽出\n- **再利用**: なし（新規作成）\n\n**型定義:**\n```typescript\nexport interface ScrapedWork {\n  sourceUrl: string;\n  sourceId: string;\n  title: string;\n  author: string;\n  language: string;\n  rawHtml: string;\n  publicationYear?: number;\n}\n```\n\n### 2. HTML Parser (`lib/scraper/parser.ts`)\n\n- **目的**: HTMLから章・段落を検出し、構造化されたデータに変換\n- **公開インターフェース**:\n  ```typescript\n  export function parseWorkStructure(\n    html: string,\n    workId: string\n  ): Promise<ParsedWork>\n  ```\n- **依存関係**:\n  - `cheerio`: HTML解析\n  - `lib/scraper/id-generator.ts`: ID生成\n- **再利用**: なし（新規作成）\n\n**型定義:**\n```typescript\nexport interface ParsedWork {\n  chapters: ParsedChapter[];\n  totalParagraphs: number;\n}\n\nexport interface ParsedChapter {\n  chapterNumber: number;\n  title: string;\n  order: number;\n  paragraphs: ParsedParagraph[];\n}\n\nexport interface ParsedParagraph {\n  id: string; // \"work-{workId}/chapter-{index}/paragraph-{index}\"\n  originalText: string;\n  order: number;\n}\n```\n\n### 3. URL Validator (`lib/scraper/url-validator.ts`)\n\n- **目的**: URLの形式検証とSSRF対策\n- **公開インターフェース**:\n  ```typescript\n  export function validateGutenbergUrl(url: string): ValidationResult\n  ```\n- **依存関係**: なし\n- **再利用**: なし（新規作成）\n\n**型定義:**\n```typescript\nexport interface ValidationResult {\n  isValid: boolean;\n  error?: string;\n  normalizedUrl?: string;\n}\n```\n\n### 4. Metadata Extractor (`lib/scraper/metadata-extractor.ts`)\n\n- **目的**: HTMLからメタデータ（タイトル、著者、言語）を抽出\n- **公開インターフェース**:\n  ```typescript\n  export function extractMetadata($: CheerioAPI): WorkMetadata\n  ```\n- **依存関係**:\n  - `cheerio`: HTML解析\n- **再利用**: なし（新規作成）\n\n**型定義:**\n```typescript\nexport interface WorkMetadata {\n  title: string;\n  author: string;\n  language: string;\n  publicationYear?: number;\n}\n```\n\n### 5. ID Generator (`lib/scraper/id-generator.ts`)\n\n- **目的**: 章・段落のユニークID生成\n- **公開インターフェース**:\n  ```typescript\n  export function generateParagraphId(\n    workId: string,\n    chapterIndex: number,\n    paragraphIndex: number\n  ): string\n  ```\n- **依存関係**: なし\n- **再利用**: なし（新規作成）\n\n### 6. Work Registration API (`app/api/works/route.ts`)\n\n- **目的**: 作品の登録と一覧取得\n- **公開インターフェース**:\n  - `POST /api/works`: 作品登録\n  - `GET /api/works`: 作品一覧取得（検索・絞込・並び替え）\n- **依存関係**:\n  - `lib/scraper/gutenberg.ts`: スクレイピング\n  - `lib/scraper/parser.ts`: パース\n  - `@prisma/client`: データベースアクセス\n- **再利用**: Next.js 15 Route Handlers\n\n**リクエスト/レスポンス:**\n```typescript\n// POST /api/works\nexport interface WorkRegistrationRequest {\n  url: string;\n  genre?: string[];\n  difficulty?: 'easy' | 'normal' | 'hard';\n}\n\nexport interface WorkRegistrationResponse {\n  id: string;\n  title: string;\n  author: string;\n  status: 'processing' | 'completed';\n  translationJobId?: string;\n}\n\n// GET /api/works\nexport interface WorkListResponse {\n  works: WorkSummary[];\n  total: number;\n  page: number;\n  pageSize: number;\n}\n```\n\n### 7. Work Deletion API (`app/api/works/[id]/route.ts`)\n\n- **目的**: 作品の削除（関連データも連鎖削除）\n- **公開インターフェース**:\n  - `DELETE /api/works/:id`: 作品削除\n  - `GET /api/works/:id`: 作品詳細取得\n- **依存関係**:\n  - `@prisma/client`: データベースアクセス\n- **再利用**: Next.js 15 Route Handlers\n\n**リクエスト/レスポンス:**\n```typescript\n// DELETE /api/works/:id\nexport interface WorkDeletionResponse {\n  success: boolean;\n  message: string;\n  deletedWorkId: string;\n}\n```\n\n### 8. WorkImportForm Component (`components/admin/WorkImportForm.tsx`)\n\n- **目的**: 作品登録フォーム（URL入力、ジャンル・難易度選択）\n- **公開インターフェース**:\n  ```typescript\n  export function WorkImportForm(): JSX.Element\n  ```\n- **依存関係**:\n  - `components/ui/*`: shadcn UIコンポーネント\n  - React Hook Form（推奨）: フォーム管理\n  - Zod: バリデーション\n- **再利用**: `components/ui/*` の既存UIコンポーネント\n\n**Props:**\n```typescript\nexport interface WorkImportFormProps {\n  onSuccess?: (workId: string) => void;\n  onError?: (error: string) => void;\n}\n```\n\n### 9. WorkList Component (`components/admin/WorkList.tsx`)\n\n- **目的**: 作品リスト表示と削除機能\n- **公開インターフェース**:\n  ```typescript\n  export function WorkList(): JSX.Element\n  ```\n- **依存関係**:\n  - `components/ui/*`: shadcn UIコンポーネント\n  - `GET /api/works`: 作品一覧取得\n  - `DELETE /api/works/:id`: 作品削除\n- **再利用**: `components/ui/*` の既存UIコンポーネント\n\n**Props:**\n```typescript\nexport interface WorkListProps {\n  initialWorks?: WorkSummary[];\n}\n```\n\n## データモデル\n\n### Prismaスキーマ\n\n```prisma\n// prisma/schema.prisma\n\ngenerator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\n// 作品\nmodel Work {\n  id                   String             @id @default(cuid())\n  title                String\n  author               String\n  publicationYear      Int?\n  isPublicDomain       Boolean            @default(true)\n  language             String             @default(\"en\")\n  genre                String[]\n  tags                 String[]\n  wordCount            Int?\n  difficulty           String?            // \"easy\" | \"normal\" | \"hard\"\n  coverUrl             String?\n  sourceUrl            String             @unique\n  sourceId             String\n  license              String?\n  popularityScore      Float              @default(0)\n  translationStatus    String             @default(\"pending\") // \"pending\" | \"in_progress\" | \"completed\" | \"failed\"\n  translationProgress  Int                @default(0) // 翻訳済み段落数\n  createdAt            DateTime           @default(now())\n  updatedAt            DateTime           @updatedAt\n\n  chapters             Chapter[]\n  translationJobs      TranslationJob[]\n  readingProgresses    ReadingProgress[]\n\n  @@index([translationStatus])\n  @@index([language])\n  @@index([difficulty])\n}\n\n// 章\nmodel Chapter {\n  id             String      @id @default(cuid())\n  workId         String\n  chapterNumber  Int\n  title          String?\n  order          Int\n  createdAt      DateTime    @default(now())\n  updatedAt      DateTime    @updatedAt\n\n  work           Work        @relation(fields: [workId], references: [id], onDelete: Cascade)\n  paragraphs     Paragraph[]\n\n  @@unique([workId, chapterNumber])\n  @@index([workId, order])\n}\n\n// 段落\nmodel Paragraph {\n  id                 String            @id // \"work-{workId}/chapter-{index}/paragraph-{index}\"\n  chapterId          String\n  originalText       String            @db.Text\n  translationNormal  String?           @db.Text\n  translationEasy    String?           @db.Text\n  order              Int\n  glossaryTags       String[]\n  createdAt          DateTime          @default(now())\n  updatedAt          DateTime          @updatedAt\n\n  chapter            Chapter           @relation(fields: [chapterId], references: [id], onDelete: Cascade)\n  readingProgresses  ReadingProgress[]\n\n  @@index([chapterId, order])\n}\n\n// 用語辞書\nmodel GlossaryTerm {\n  id             String   @id @default(cuid())\n  originalTerm   String   @unique\n  translation    String\n  difficulty     String?  // \"easy\" | \"normal\" | \"hard\"\n  definition     String?  @db.Text\n  synonyms       String[]\n  easyAlternative String?\n  createdAt      DateTime @default(now())\n  updatedAt      DateTime @updatedAt\n\n  @@index([originalTerm])\n}\n\n// ユーザープロフィール（将来的に認証機能追加時に使用）\nmodel UserProfile {\n  id               String            @id @default(cuid())\n  email            String?           @unique\n  displayName      String?\n  fontSize         String?\n  theme            String?\n  defaultMode      String?           // \"original\" | \"japanese\" | \"parallel\"\n  createdAt        DateTime          @default(now())\n  updatedAt        DateTime          @updatedAt\n\n  readingProgresses ReadingProgress[]\n  chatLogs         ChatLog[]\n}\n\n// 読書進捗\nmodel ReadingProgress {\n  id           String      @id @default(cuid())\n  userId       String\n  workId       String\n  paragraphId  String\n  updatedAt    DateTime    @updatedAt\n\n  user         UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)\n  work         Work        @relation(fields: [workId], references: [id], onDelete: Cascade)\n  paragraph    Paragraph   @relation(fields: [paragraphId], references: [id], onDelete: Cascade)\n\n  @@unique([userId, workId])\n  @@index([userId])\n  @@index([workId])\n}\n\n// チャットログ\nmodel ChatLog {\n  id                String      @id @default(cuid())\n  userId            String?\n  question          String      @db.Text\n  answer            String      @db.Text\n  referencedParagraphIds String[]\n  mode              String?     // \"original\" | \"japanese\" | \"parallel\"\n  createdAt         DateTime    @default(now())\n\n  user              UserProfile? @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n  @@index([createdAt])\n}\n\n// 翻訳ジョブ\nmodel TranslationJob {\n  id              String    @id @default(cuid())\n  workId          String\n  status          String    @default(\"pending\") // \"pending\" | \"in_progress\" | \"completed\" | \"failed\"\n  translationType String    // \"normal\" | \"easy\" | \"both\"\n  totalCount      Int       // 全段落数\n  completedCount  Int       @default(0) // 処理済み段落数\n  errorLog        String?   @db.Text\n  startedAt       DateTime?\n  completedAt     DateTime?\n  createdAt       DateTime  @default(now())\n  updatedAt       DateTime  @updatedAt\n\n  work            Work      @relation(fields: [workId], references: [id], onDelete: Cascade)\n\n  @@index([workId])\n  @@index([status])\n}\n```\n\n## エラーハンドリング\n\n### エラーシナリオ\n\n1. **無効なURL**\n   - **ハンドリング**: `url-validator.ts`でURL形式とドメインを検証し、不正な場合は400エラーを返す\n   - **ユーザーへの影響**: 「URLが無効です。Project GutenbergのHTML形式URLを入力してください。」と表示\n\n2. **HTMLフェッチ失敗**\n   - **ハンドリング**: `fetch()`のエラーをキャッチし、502エラーを返す。一時的なエラーの場合は3回までリトライ（指数バックオフ）\n   - **ユーザーへの影響**: 「ページの取得に失敗しました。URLを確認するか、しばらくしてから再試行してください。」と表示\n\n3. **HTMLパース失敗**\n   - **ハンドリング**: `parser.ts`でパースエラーをキャッチし、422エラーを返す。詳細なエラーメッセージ（「タイトルが見つかりません」等）をログに記録\n   - **ユーザーへの影響**: 「ページの解析に失敗しました。このURLは対応していない可能性があります。」と表示\n\n4. **データベース書き込み失敗**\n   - **ハンドリング**: Prismaのトランザクションでロールバック。エラーログを記録し、500エラーを返す\n   - **ユーザーへの影響**: 「作品の登録に失敗しました。管理者に連絡してください。」と表示\n\n5. **重複URL登録**\n   - **ハンドリング**: データベースのユニーク制約エラーをキャッチし、409エラーを返す\n   - **ユーザーへの影響**: 「この作品は既に登録されています。」と表示\n\n6. **削除対象の作品が存在しない**\n   - **ハンドリング**: Prismaの`findUnique()`で作品を検索し、存在しない場合は404エラーを返す\n   - **ユーザーへの影響**: 「指定された作品が見つかりません。」と表示\n\n7. **削除トランザクション失敗**\n   - **ハンドリング**: Prismaのトランザクションでロールバック。部分削除を防ぐ。エラーログを記録し、500エラーを返す\n   - **ユーザーへの影響**: 「作品の削除に失敗しました。管理者に連絡してください。」と表示\n\n8. **SSRF攻撃（プライベートIPへのアクセス）**\n   - **ハンドリング**: `url-validator.ts`でプライベートIPアドレス（127.0.0.1、192.168.x.x、10.x.x.x等）を検出し、403エラーを返す\n   - **ユーザーへの影響**: 「このURLはアクセスできません。」と表示\n\n9. **レート制限超過**\n   - **ハンドリング**: ミドルウェアまたはAPI内でレート制限チェック。超過した場合は429エラーを返す\n   - **ユーザーへの影響**: 「登録回数の制限を超えました。10分後に再試行してください。」と表示\n\n## テスト戦略\n\n### ユニットテスト\n\n**テスト対象:**\n- `lib/scraper/url-validator.ts`: URL検証ロジック\n  - 有効なProject Gutenberg URL\n  - 無効なドメイン\n  - プライベートIPアドレス\n  - 不正な形式のURL\n- `lib/scraper/metadata-extractor.ts`: メタデータ抽出\n  - 正常なHTML（タイトル、著者、言語が正しく抽出される）\n  - タイトルがない場合\n  - 著者がない場合\n- `lib/scraper/id-generator.ts`: ID生成\n  - 一意性の検証\n  - 形式の検証（`work-{workId}/chapter-{index}/paragraph-{index}`）\n- `lib/scraper/parser.ts`: 章・段落の検出\n  - 正常なHTML（章と段落が正しく検出される）\n  - 空の段落を除外\n  - ナビゲーション要素を除外\n\n**テストフレームワーク:** Jest + Testing Library\n\n### 統合テスト\n\n**テスト対象:**\n- `POST /api/works`: 作品登録フロー\n  - 正常なURL → データベースに正しくレコードが作成される\n  - 無効なURL → 400エラー\n  - 重複URL → 409エラー\n  - フェッチ失敗 → 502エラー\n  - パース失敗 → 422エラー\n- `DELETE /api/works/:id`: 作品削除フロー\n  - 正常な削除 → 関連データも連鎖削除される\n  - 存在しない作品 → 404エラー\n  - 削除失敗 → トランザクションがロールバックされる\n\n**テストフレームワーク:** Jest + Supertest（APIテスト）、Prismaのテストデータベース\n\n### エンドツーエンドテスト\n\n**テスト対象:**\n- 管理画面での作品登録シナリオ\n  1. 管理画面にアクセス\n  2. URLを入力\n  3. ジャンルと難易度を選択\n  4. 登録ボタンをクリック\n  5. 成功メッセージが表示される\n  6. 作品リストに新しい作品が表示される\n- 管理画面での作品削除シナリオ\n  1. 作品リストで削除ボタンをクリック\n  2. 確認ダイアログが表示される\n  3. 確認ボタンをクリック\n  4. 成功メッセージが表示される\n  5. 作品リストから削除される\n\n**テストフレームワーク:** Playwright または Cypress\n",
  "fileStats": {
    "size": 22272,
    "lines": 623,
    "lastModified": "2025-11-07T02:17:20.936Z"
  },
  "comments": []
}