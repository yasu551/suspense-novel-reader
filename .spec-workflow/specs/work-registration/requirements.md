# 要件定義書：作品登録機能

## はじめに

作品登録機能は、管理者がProject GutenbergなどのパブリックドメインサイトからURLを指定するだけで、英語小説をシステムに取り込める機能です。この機能により、手動でのテキスト入力やコピー＆ペーストが不要となり、大量の古典作品を効率的にデータベースに登録できます。

### 機能の目的
- 管理者の作業負荷を大幅に削減
- 作品メタデータの自動抽出による正確性の向上
- 章・段落の自動構造化による読書体験の向上
- 登録後の自動翻訳パイプラインとの連携

### ユーザーへの価値
- 豊富な作品ラインナップを短期間で実現
- 構造化されたテキストによる快適な読書体験
- 翻訳機能との統合による日本語学習支援

## プロダクトビジョンとの整合性

本機能はClaude.mdに記載されたプロダクトビジョン「英語原文の小説を日本語でやさしく読めるようにする」の基盤となります。

- **MVPスコープ（優先度0番）**: 管理画面でのURLベース作品登録・削除機能
- **自動翻訳機能との連携**: 作品登録完了後、自動的に翻訳ジョブを開始
- **将来の拡張性**: Project Gutenberg以外のパブリックドメインサイトへの対応が可能な設計

## 要件

### 要件1: Project GutenbergからのURL指定による作品登録

**ユーザーストーリー:** 管理者として、Project GutenbergのHTML形式URLを入力することで、作品のメタデータと本文を自動的にシステムに登録したい。これにより、手動でのテキスト入力作業を削減できる。

#### 受け入れ基準

1. WHEN 管理者が有効なProject Gutenberg URLを入力 THEN システムは30秒以内にメタデータと章・段落を抽出する
2. WHEN URLからHTMLをフェッチ THEN システムは以下のメタデータを抽出する:
   - タイトル（`<h1>` または `<title>` タグから）
   - 著者名（`<h2>` または `rel="dcterms:creator"` 属性から）
   - 言語（`<html lang="...">` またはメタタグから）
   - 出典ID（URLから抽出）
3. WHEN 章の検出 THEN システムは `<h2>`, `<h3>` タグで"CHAPTER"を含むものを章として識別する
4. WHEN 段落の検出 THEN システムは `<p>` タグを段落として識別し、空の段落・ナビゲーション要素を除外する
5. WHEN 章・段落にID付与 THEN システムは `work-{workId}/chapter-{index}/paragraph-{index}` の形式でユニークIDを生成する
6. WHEN メタデータと構造化テキストの抽出完了 THEN システムはデータベースに以下のレコードを作成する:
   - Workレコード（`translation_status: 'pending'`）
   - Chapterレコード（一括作成）
   - Paragraphレコード（バッチ処理で一括作成）
   - TranslationJobレコード

### 要件2: 作品登録後の自動翻訳ジョブ開始

**ユーザーストーリー:** 管理者として、作品登録が完了したら、自動的に翻訳処理が開始されてほしい。これにより、手動で翻訳ジョブを起動する手間が省ける。

#### 受け入れ基準

1. WHEN 作品のデータベース登録が完了 THEN システムは自動的に翻訳ジョブをキューに追加する
2. WHEN 翻訳ジョブが開始 THEN システムはWorkレコードの `translation_status` を `in_progress` に更新する
3. WHEN 環境変数 `TRANSLATION_AUTO_START` が `false` AND 作品登録完了 THEN システムは翻訳ジョブを開始せず、`translation_status` を `pending` のままにする

### 要件3: URL検証とエラーハンドリング

**ユーザーストーリー:** 管理者として、無効なURLや取得できないURLを入力した場合、明確なエラーメッセージを受け取りたい。これにより、問題を迅速に特定し修正できる。

#### 受け入れ基準

1. WHEN 管理者がProject Gutenberg以外のURLを入力 THEN システムは400エラーを返し「許可されたドメインではありません」と表示する
2. WHEN URLからのHTMLフェッチが失敗 THEN システムは502エラーを返し「ページの取得に失敗しました」と表示する
3. WHEN HTMLのパースが失敗（タイトルまたは著者が抽出できない） THEN システムは422エラーを返し詳細なエラーメッセージを表示する
4. IF プライベートIPアドレスへのアクセス THEN システムはSSRF対策としてリクエストを拒否する
5. WHEN 同一URLで既に登録済みの作品が存在 THEN システムは409エラーを返し「この作品は既に登録されています」と表示する

### 要件4: 作品の削除と関連データの連鎖削除

**ユーザーストーリー:** 管理者として、不要な作品を削除する際に、関連する章・段落・進捗データも自動的に削除されてほしい。これにより、データベースの整合性が保たれる。

#### 受け入れ基準

1. WHEN 管理者が作品削除を実行 THEN システムは確認ダイアログを表示する
2. WHEN 削除が確認される THEN システムは以下の順序でデータを削除する:
   - TranslationJob（該当作品の翻訳ジョブ）
   - ChatLog（該当作品の段落を参照するもの）
   - ReadingProgress（該当作品の段落）
   - Paragraph（該当作品の章）
   - Chapter（該当作品）
   - Work
3. WHEN 削除処理中にエラーが発生 THEN システムはトランザクションをロールバックし、データの一部削除を防ぐ
4. IF 進行中の翻訳ジョブが存在 THEN システムは翻訳ジョブをキャンセルしてから削除を実行する

### 要件5: 作品登録のプレビュー機能

**ユーザーストーリー:** 管理者として、作品を正式に登録する前に、抽出されたメタデータと章構造をプレビューしたい。これにより、パース結果が正しいか確認してから登録できる。

#### 受け入れ基準

1. WHEN 管理者がURLを入力して「プレビュー」ボタンをクリック THEN システムはスクレイピング・パースを実行し結果を表示する（DBには保存しない）
2. WHEN プレビュー画面 THEN システムは以下の情報を表示する:
   - 抽出されたタイトル
   - 抽出された著者名
   - 検出された章数
   - 検出された段落数
   - 最初の3章のタイトルと段落プレビュー
3. WHEN プレビュー結果が正しい AND 管理者が「登録」ボタンをクリック THEN システムはデータベースに保存する
4. WHEN プレビュー結果が不正 THEN 管理者はURLを修正するか、手動でメタデータを編集してから登録できる

### 要件6: ジャンル・難易度の設定

**ユーザーストーリー:** 管理者として、作品登録時にジャンルと難易度を設定したい。これにより、ユーザーが作品一覧画面でフィルタリングできるようになる。

#### 受け入れ基準

1. WHEN 管理者が作品登録フォームを入力 THEN システムはジャンルの複数選択オプションを提供する:
   - ゴシック、SF、冒険、恋愛、ミステリー、ホラー、その他
2. WHEN 管理者が作品登録フォームを入力 THEN システムは難易度の選択オプションを提供する:
   - やさしい、ふつう、むずかしい
3. IF 管理者がジャンル・難易度を指定しない THEN システムはデフォルト値（ジャンル: 未分類、難易度: ふつう）を設定する
4. WHEN 将来的にAIによる自動推定機能を追加 THEN システムは推定値を提案し、管理者が修正可能にする

## 非機能要件

### コードアーキテクチャとモジュール性

- **単一責任の原則**: 各ファイルは明確に定義された単一の目的を持つ
  - `lib/scraper/gutenberg.ts`: Project Gutenbergのスクレイピング専用
  - `lib/scraper/parser.ts`: HTML/テキストのパース専用
  - `app/api/works/route.ts`: 作品一覧・登録APIエンドポイント
  - `app/api/works/[id]/route.ts`: 作品削除APIエンドポイント
- **モジュラー設計**: コンポーネント、ユーティリティ、サービスは独立して再利用可能
  - スクレイパーは他のパブリックドメインサイトに拡張可能
  - パーサーはテキスト形式にも対応可能
- **依存関係の管理**: モジュール間の相互依存を最小化
  - スクレイパーはパーサーに依存しない
  - APIルートはスクレイパー・パーサーをインポートするが、逆方向の依存は持たない
- **明確なインターフェース**: コンポーネント間とレイヤー間のクリーンな契約を定義
  - スクレイパー関数は標準的な戻り値型（`ScrapedWork`）を返す
  - APIエンドポイントは標準的なHTTPステータスコードとレスポンス形式を使用

### パフォーマンス

- URLから作品を登録すると、30秒以内にメタデータと章・段落が抽出される
- データベース書き込みはバッチ処理で実行し、1000段落の作品で10秒以内に完了
- 作品削除は関連データの量に応じて5〜30秒以内に完了
- プレビュー機能は15秒以内に結果を表示（DBには保存しない）

### セキュリティ

- **URL検証**: 許可されたドメイン（gutenberg.org）のみを受け入れる
- **SSRF対策**: プライベートIPアドレス（127.0.0.1、192.168.x.x、10.x.x.x等）へのアクセスを禁止
- **レート制限**: 作品登録は1ユーザー/10分あたり5件まで（IP + ユーザーIDベース）
- **管理画面へのアクセス制御**: 将来的に認証必須（OAuth or Token）
- **翻訳ジョブの同時実行制限**: 1作品につき1ジョブまで
- **入力検証**: URLとメタデータ入力に対するXSS・SQLインジェクション対策

### 信頼性

- データベーストランザクションによる作品削除の原子性保証
- 翻訳ジョブ開始失敗時のロールバック処理
- スクレイピング失敗時の詳細なエラーログ記録
- リトライ機構（一時的なネットワークエラーに対応）

### ユーザビリティ

- 明確で具体的なエラーメッセージ（技術的な詳細ではなく、ユーザーが理解できる言葉）
- プレビュー機能による登録前の確認
- 削除確認ダイアログによる誤操作防止
- 翻訳進捗のリアルタイム表示（5秒以内に更新）
